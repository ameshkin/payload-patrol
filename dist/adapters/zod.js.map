{"version":3,"sources":["../../src/adapters/zod.ts"],"sourcesContent":["/**\n * Zod adapter for Payload Patrol\n * Lightweight integration for schema-level validation\n */\n\nimport { z } from \"zod\";\nimport { auditPayload } from \"../index\";\nimport type { CheckName, AdapterMode } from \"../types\";\n\nexport interface ZodSafeStringOptions {\n  /** Maximum string length */\n  maxLength?: number;\n  /** Minimum string length */\n  minLength?: number;\n  /** Block SQL injection patterns (default: true) */\n  blockSQLi?: boolean;\n  /** Block XSS/script patterns (default: true) */\n  blockXSS?: boolean;\n  /** Allow HTML tags (default: false) */\n  allowHTML?: boolean;\n  /** Check profanity (default: false) */\n  checkProfanity?: boolean;\n  /** Maximum character count */\n  maxChars?: number;\n  /** Maximum word count */\n  maxWords?: number;\n  /** Allowlist of terms */\n  allowlist?: string[];\n  /** Adapter mode (default: \"block\") */\n  adapter?: AdapterMode;\n  /** Custom error message */\n  message?: string;\n}\n\n/**\n * Create a safe string schema with Payload Patrol validation\n * \n * @example\n * ```ts\n * const schema = z.object({\n *   name: zSafeString({ maxLength: 128 }),\n *   email: zSafeString({ allowHTML: false }),\n *   bio: zSafeString({ maxChars: 500, checkProfanity: true })\n * });\n * ```\n */\nexport function zSafeString(opts: ZodSafeStringOptions = {}) {\n  const {\n    maxLength,\n    minLength,\n    blockSQLi = true,\n    blockXSS = true,\n    allowHTML = false,\n    checkProfanity = false,\n    maxChars,\n    maxWords,\n    allowlist,\n    adapter = \"block\",\n    message,\n  } = opts;\n\n  let schema = z.string();\n\n  // Apply basic string validations\n  if (minLength !== undefined) {\n    schema = schema.min(minLength);\n  }\n  if (maxLength !== undefined) {\n    schema = schema.max(maxLength);\n  }\n\n  // Add Payload Patrol refinement\n  return schema.refine(\n    async (value) => {\n      const checks: CheckName[] = [];\n      \n      if (checkProfanity) checks.push(\"badwords\");\n      if (blockSQLi) checks.push(\"sql\");\n      if (blockXSS) checks.push(\"scripts\");\n      if (!allowHTML) checks.push(\"html\");\n      if (maxChars || maxWords) checks.push(\"limit\");\n\n      const result = await auditPayload(value, {\n        adapter,\n        checks,\n        context: {\n          limit: { maxChars, maxWords },\n          allowlist,\n        },\n      });\n\n      return result.ok;\n    },\n    {\n      message: message || \"Input contains unsafe content\",\n      // Provide detailed error via params\n      params: {\n        code: \"unsafe_content\",\n      },\n    }\n  );\n}\n\n/**\n * Create a safe object schema that validates all string fields\n * \n * @example\n * ```ts\n * const schema = zSafeObject({\n *   name: z.string(),\n *   email: z.string().email(),\n *   age: z.number()\n * }, { blockXSS: true, blockSQLi: true });\n * ```\n */\nexport function zSafeObject<T extends z.ZodRawShape>(\n  shape: T,\n  opts: Omit<ZodSafeStringOptions, \"maxLength\" | \"minLength\"> = {}\n) {\n  return z.object(shape).refine(\n    async (value) => {\n      const result = await auditPayload(value, {\n        adapter: opts.adapter || \"block\",\n        checks: [\n          ...(opts.checkProfanity ? [\"badwords\" as CheckName] : []),\n          ...(opts.blockSQLi !== false ? [\"sql\" as CheckName] : []),\n          ...(opts.blockXSS !== false ? [\"scripts\" as CheckName] : []),\n          ...(opts.allowHTML === false ? [\"html\" as CheckName] : []),\n        ],\n        context: {\n          limit: { maxChars: opts.maxChars, maxWords: opts.maxWords },\n          allowlist: opts.allowlist,\n        },\n      });\n      return result.ok;\n    },\n    {\n      message: opts.message || \"Object contains unsafe content\",\n      params: {\n        code: \"unsafe_content\",\n      },\n    }\n  );\n}\n\n/**\n * Transform that strips unsafe content instead of blocking\n * \n * @example\n * ```ts\n * const schema = z.string().transform(zStripUnsafe());\n * ```\n */\nexport function zStripUnsafe(opts: Omit<ZodSafeStringOptions, \"adapter\"> = {}) {\n  return async (value: string) => {\n    const checks: CheckName[] = [];\n    \n    if (opts.blockXSS !== false) checks.push(\"scripts\");\n    if (!opts.allowHTML) checks.push(\"html\");\n\n    const result = await auditPayload(value, {\n      adapter: \"strip\",\n      checks,\n      context: {\n        allowlist: opts.allowlist,\n      },\n    });\n\n    return (result.value as string) || value;\n  };\n}\n"],"mappings":";;;;;AAKA,SAAS,SAAS;AAyCX,SAAS,YAAY,OAA6B,CAAC,GAAG;AAC3D,QAAM;AAAA,IACJ;AAAA,IACA;AAAA,IACA,YAAY;AAAA,IACZ,WAAW;AAAA,IACX,YAAY;AAAA,IACZ,iBAAiB;AAAA,IACjB;AAAA,IACA;AAAA,IACA;AAAA,IACA,UAAU;AAAA,IACV;AAAA,EACF,IAAI;AAEJ,MAAI,SAAS,EAAE,OAAO;AAGtB,MAAI,cAAc,QAAW;AAC3B,aAAS,OAAO,IAAI,SAAS;AAAA,EAC/B;AACA,MAAI,cAAc,QAAW;AAC3B,aAAS,OAAO,IAAI,SAAS;AAAA,EAC/B;AAGA,SAAO,OAAO;AAAA,IACZ,OAAO,UAAU;AACf,YAAM,SAAsB,CAAC;AAE7B,UAAI,eAAgB,QAAO,KAAK,UAAU;AAC1C,UAAI,UAAW,QAAO,KAAK,KAAK;AAChC,UAAI,SAAU,QAAO,KAAK,SAAS;AACnC,UAAI,CAAC,UAAW,QAAO,KAAK,MAAM;AAClC,UAAI,YAAY,SAAU,QAAO,KAAK,OAAO;AAE7C,YAAM,SAAS,MAAM,aAAa,OAAO;AAAA,QACvC;AAAA,QACA;AAAA,QACA,SAAS;AAAA,UACP,OAAO,EAAE,UAAU,SAAS;AAAA,UAC5B;AAAA,QACF;AAAA,MACF,CAAC;AAED,aAAO,OAAO;AAAA,IAChB;AAAA,IACA;AAAA,MACE,SAAS,WAAW;AAAA;AAAA,MAEpB,QAAQ;AAAA,QACN,MAAM;AAAA,MACR;AAAA,IACF;AAAA,EACF;AACF;AAcO,SAAS,YACd,OACA,OAA8D,CAAC,GAC/D;AACA,SAAO,EAAE,OAAO,KAAK,EAAE;AAAA,IACrB,OAAO,UAAU;AACf,YAAM,SAAS,MAAM,aAAa,OAAO;AAAA,QACvC,SAAS,KAAK,WAAW;AAAA,QACzB,QAAQ;AAAA,UACN,GAAI,KAAK,iBAAiB,CAAC,UAAuB,IAAI,CAAC;AAAA,UACvD,GAAI,KAAK,cAAc,QAAQ,CAAC,KAAkB,IAAI,CAAC;AAAA,UACvD,GAAI,KAAK,aAAa,QAAQ,CAAC,SAAsB,IAAI,CAAC;AAAA,UAC1D,GAAI,KAAK,cAAc,QAAQ,CAAC,MAAmB,IAAI,CAAC;AAAA,QAC1D;AAAA,QACA,SAAS;AAAA,UACP,OAAO,EAAE,UAAU,KAAK,UAAU,UAAU,KAAK,SAAS;AAAA,UAC1D,WAAW,KAAK;AAAA,QAClB;AAAA,MACF,CAAC;AACD,aAAO,OAAO;AAAA,IAChB;AAAA,IACA;AAAA,MACE,SAAS,KAAK,WAAW;AAAA,MACzB,QAAQ;AAAA,QACN,MAAM;AAAA,MACR;AAAA,IACF;AAAA,EACF;AACF;AAUO,SAAS,aAAa,OAA8C,CAAC,GAAG;AAC7E,SAAO,OAAO,UAAkB;AAC9B,UAAM,SAAsB,CAAC;AAE7B,QAAI,KAAK,aAAa,MAAO,QAAO,KAAK,SAAS;AAClD,QAAI,CAAC,KAAK,UAAW,QAAO,KAAK,MAAM;AAEvC,UAAM,SAAS,MAAM,aAAa,OAAO;AAAA,MACvC,SAAS;AAAA,MACT;AAAA,MACA,SAAS;AAAA,QACP,WAAW,KAAK;AAAA,MAClB;AAAA,IACF,CAAC;AAED,WAAQ,OAAO,SAAoB;AAAA,EACrC;AACF;","names":[]}